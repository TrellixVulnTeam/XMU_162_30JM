library(ggplot2)
library(Rcpp)
library(readxl)
library(dplyr)
library(stringr)
library(ggpubr)
library(gridExtra)
library(ggpval)
library(pheatmap)
library(reshape2)

setwd("/share/data0/QTLbase/huan/GTEx/Tissue_merge/Cis_eQTL/hotspot/interval_18/kmer/6/chr1_and_22/factor_anno/")
All <-read.table("../communities.bed.gz",header = F,sep = "\t") %>% as.data.frame()
CHROMATIN_Accessibility <-read.table("CHROMATIN_Accessibility.bed.gz",header = F,sep = "\t") %>% as.data.frame()
CTCF<-read.table("CTCF.bed.gz",header = F,sep = "\t") %>% as.data.frame()
TFBS<-read.table("TFBS.bed.gz",header = F,sep = "\t") %>% as.data.frame()

H3K27ac<-read.table("H3K27ac.bed.gz",header = F,sep = "\t") %>% as.data.frame() #active
H3K27me3<-read.table("H3K27me3.bed.gz",header = F,sep = "\t") %>% as.data.frame() #repressed
H3K36me3<-read.table("H3K36me3.bed.gz",header = F,sep = "\t") %>% as.data.frame() #transcribed
H3K4me1<-read.table("H3K4me1.bed.gz",header = F,sep = "\t") %>% as.data.frame() #enhancer
H3K4me3<-read.table("H3K4me3.bed.gz",header = F,sep = "\t") %>% as.data.frame() #promoter
H3K9ac<-read.table("H3K9ac.bed.gz",header = F,sep = "\t") %>% as.data.frame() #active
H3K9me3<-read.table("H3K9me3.bed.gz",header = F,sep = "\t") %>% as.data.frame() #gene silencing

# Active_histone <-bind_rows(H3K27ac,H3K36me3,H3K4me1,H3K4me3,H3K9ac)
# Silent_histone <-bind_rows(H3K27me3,H3K9me3)


CHROMATIN_Accessibility$Class<-"CHROMATIN Accessibility"
CTCF$Class<-"CTCF"
TFBS$Class<-"TFBS"
H3K27ac$Class<-"H3K27ac"
H3K36me3$Class<-"H3K36me3"
H3K4me1$Class<-"H3K4me1"
H3K4me3$Class<-"H3K4me3"
H3K9ac$Class<-"H3K9ac"
H3K27me3$Class<-"H3K27me3"
H3K9me3$Class<-"H3K9me3"

cluster <-table(All$V4)%>%data.frame()

colnames(cluster) <-c("cluster_number","count")
cluster <-rbind(cluster,data.frame(cluster_number ="All",count = nrow(All)))

# cluster_number <-c(0,1,2,3,5,"All")
# count <-c(18739,18477,4617,4429,103,46369)
# cluster <-data.frame(cluster_number,count)
# all_anno <-bind_rows(CHROMATIN_Accessibility,CTCF,TFBS,H3K27ac,H3K36me3,H3K4me1,H3K4me3,H3K9ac,H3K27me3,H3K9me3)
all_anno <-bind_rows(CHROMATIN_Accessibility,TFBS,CTCF,H3K27ac,H3K36me3,H3K4me1,H3K4me3,H3K9ac,H3K27me3,H3K9me3)
colnames(all_anno)[4] <-"cluster_number"
all_anno$pos <-paste(all_anno$V1,all_anno$V2,all_anno$V3,sep="_")
anno_count <-all_anno%>%group_by(cluster_number,Class)%>%summarise(factor=n())%>%as.data.frame()

# anno_count_all <-filter(all_anno,cluster_number!=4)%>%group_by(Class)%>%summarise(factor=n())%>%as.data.frame()
anno_count_all <-all_anno%>%group_by(Class)%>%summarise(factor=n())%>%as.data.frame()
anno_count_all$cluster_number <-"All"
anno_count_all <- anno_count_all[,c("cluster_number", "Class", "factor")]
anno_count$cluster_number <-as.character(anno_count$cluster_number)
anno_count <-bind_rows(anno_count_all,anno_count)


final_data <-left_join(anno_count, cluster, by = "cluster_number")
final_data$factor<-as.numeric(as.character(final_data$factor))
final_data$ratio <- final_data$factor/final_data$count
final_data2 <-final_data
# final_data2 <-filter(final_data,cluster_number!=4)

figure_used <-acast(final_data2[,c(1,2,5)],Class~cluster_number)
aaa <-data.frame(figure_used)
colnames(aaa)<-cluster$cluster_number
aaa<-aaa[c("CHROMATIN Accessibility","TFBS","CTCF","H3K27ac","H3K36me3","H3K4me1","H3K4me3","H3K9ac","H3K27me3","H3K9me3"),]
color2 = colorRampPalette(c('#c6dbef','#6baed6','#2171b5'))(50)
setwd("/home/huanhuan/project/RNA/eQTL_associated_interaction/GTEx/script/Tissue_merge/chr1_and_22/")
pdf("./figure/10_kmer_heatmap_contain_all_no_scale_Chr1_and_22.pdf")
pheatmap(as.matrix(aaa),cluster_rows = FALSE, cluster_cols = FALSE,color= color2,angle_col = 0,display_numbers = TRUE)
dev.off()
write.table(aaa,"./figure/before_scale_cluster_factor_ratio.txt", row.names=T, col.names = T,quote =F,sep="\t")

# # Active_histone <-bind_rows(H3K27ac,H3K36me3,H3K4me1,H3K4me3,H3K9ac)
# # Silent_histone <-bind_rows(H3K27me3,H3K9me3)
# normalization<-function(x){
#       return((x -min(x)) / (max(x)-min(x)))}

# # normalization<-function(x){
# #       return(x /max(x))}

# # BBB<-apply(figure_use,1,normalization)%>%data.frame()%>%t()%>%as.matrix()

# BBB<-apply(aaa,1,normalization)%>%data.frame()%>%t()
# # colnames(BBB)<-cluster_number
# color2 = colorRampPalette(c('#c6dbef','#6baed6','#2171b5'))(50)

# setwd("/home/huanhuan/project/RNA/eQTL_associated_interaction/GTEx/script/Whole_blood/extend_kmer/")
# pdf("./figure/06_kmer_heatmap_contain_all.pdf")
# pheatmap(as.matrix(BBB),cluster_rows = FALSE, cluster_cols = FALSE,color= color2,angle_col = 0)
# dev.off()

# pdf("./figure/06_kmer_heatmap_contain_all_no_scale.pdf")
# pheatmap(as.matrix(aaa),cluster_rows = FALSE, cluster_cols = FALSE,color= color2,angle_col = 0)
# dev.off()

# setwd("/home/huanhuan/project/RNA/eQTL_associated_interaction/GTEx/script/Whole_blood/extend_kmer/")
# pdf("./figure/06_kmer_heatmap_contain_all_number.pdf")
# pheatmap(as.matrix(BBB),cluster_rows = FALSE, cluster_cols = FALSE,color= color2,angle_col = 0,display_numbers = TRUE)
# dev.off()

# pdf("./figure/06_kmer_heatmap_contain_all_no_scale_number.pdf")
# pheatmap(as.matrix(aaa),cluster_rows = FALSE, cluster_cols = FALSE,color= color2,angle_col = 0,display_numbers = TRUE)
# dev.off()



# out_aaa <-aaa

# out_aaa$Factor <-rownames(out_aaa)

# out_BBB <-BBB%>%as.data.frame()
# out_BBB$Factor <-rownames(out_BBB)

# write.table(out_aaa,"./figure/before_scale_cluster_factor_ratio.txt", row.names=F, col.names = T,quote =F,sep="\t")
# # write.table(out_BBB,"./figure/after_scale_cluster_factor_ratio.txt", row.names=F, col.names = T,quote =F,sep="\t")
# write.table(final_data2,"./figure/cluster_factor_count.txt", row.names=F, col.names = T,quote =F,sep="\t")
# # pdf(figure_name)
# # title = "qqqq"
# # pheatmap(BBB,cluster_rows = FALSE, cluster_cols = FALSE,color = color2,fontsize_row=1.5,fontsize_col=4,cellwidth=7,fontsize=5, main =title)
# # dev.off()
